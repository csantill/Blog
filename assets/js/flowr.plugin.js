(function(h){h.fn.flowr=function(n){$this=this;var p=["complete","data","responsive"],e={data:[],padding:5,height:240,render:null,append:!1,widthAttr:"width",heightAttr:"height",maxScale:1.5,maxWidth:this.width()-1,itemWidth:null,itemHeight:null,complete:null,rowClassName:"flowr-row",rows:-1,responsive:!0},a=h.extend(e,n);if(a.append&&$this.data("lastSettings")){lastSettings=$this.data("lastSettings");for(attr in e){0>p.indexOf(attr)&&a[attr]==e[attr]&&(a[attr]=lastSettings[attr])}lastRow=$this.data("lastRow");0<lastRow.data.length&&25<a.maxWidth-lastRow.width&&(lastRowData=lastSettings.data.slice(lastSettings.data.length-lastRow.data.length-1),a.data=lastRowData.concat(a.data),h("."+a.rowClassName+":last",$this).detach())}a.responsive||a.append||$this.width($this.width());if(a.data instanceof Array){"number"!=typeof a.padding&&(a.padding=parseInt(a.padding));"function"!=typeof a.itemWidth&&(a.itemWidth=function(c){return c[a.widthAttr]});"function"!=typeof a.itemHeight&&(a.itemHeight=function(c){return c[a.heightAttr]});var m={getNextRow:function(a,b){var c=0,g=a.length,f=[],k=0;for(requiredPadding=function(){return(f.length-1+(1==arguments.length?arguments[0]:0))*b.padding};k+requiredPadding()<b.maxWidth&&c<g;){var l=a[c],d=b.itemWidth.call($this,l),h=b.itemHeight.call($this,l),e=b.height,d=Math.floor(d*b.height/h);d>b.maxWidth&&(d=b.maxWidth-1-requiredPadding(1),e=b.height*e/d);if(k+d<b.maxWidth){f.push({height:e,width:d,itemData:l}),k+=d,c++}else{break}}testWidth=0;if(k<b.maxWidth){for(a=(b.maxWidth-requiredPadding()-10)/k,a>b.maxScale&&(a=1),c=Math.round(b.height*a),i=0;i<f.length;i++){g=f[i],g.width=Math.floor(g.width*a),g.height=c,testWidth+=g.width}}return{data:f,width:testWidth+requiredPadding()}},reorderContent:function(){var a=$this.data("width"),b=$this.width();a!=b&&($this.html(""),a=$this.data("lastSettings"),a.data=$this.data("data"),a.maxWidth=$this.width()-1,$this.flowr(a))}};a.responsive&&!$this.data("__responsive")&&(h(window).resize(function(){initialWidth=$this.data("width");newWidth=$this.width();if(initialWidth!=newWidth){var a=$this.data("task_id");a&&clearTimeout(a);a=setTimeout(m.reorderContent,80);$this.data("task_id",a)}}),$this.data("__responsive",!0));return this.each(function(){var c=a.data.slice(0),b=null,e=0,g=0,f=[];for(i=0;i<c.length;i++){f.push(c[i])}for($this.data("data",f);null!=(b=m.getNextRow(c,a))&&0<b.data.length&&!(0<a.rows&&e>=a.rows);){c.splice(0,b.data.length);var f=h("<div>").addClass(a.rowClassName),k=$this[0].clientWidth-b.width-2*a.padding;for(i=0;i<b.data.length;i++){var l=b.data[i],d=a.render.call($this,l),d=h(d);extraw=Math.floor(k/b.data.length);0==i&&(extraw+=k%b.data.length);d.css("width",l.width+extraw).css("height",l.height).css("margin-bottom",a.padding+"px").css("margin-left",0==i?"0":a.padding+"px");f.append(d);g++}$this.append(f);e++;$this.data("lastRow",b)}$this.data("lastSettings",a);"function"==typeof a.complete&&a.complete.call($this,{renderedRows:e,renderedItems:g})})}}})(jQuery);